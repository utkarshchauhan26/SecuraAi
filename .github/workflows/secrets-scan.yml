name: Security - Secrets Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  secrets-scan:
    name: Detect Leaked Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for thorough scanning

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run secrets baseline scan
        run: |
          echo "=== SecuraAI Secrets Scanner ==="
          echo "Scanning for leaked credentials, API keys, and secrets..."
          echo ""
          
          # Run detect-secrets on the entire repo
          detect-secrets scan \
            --exclude-files 'pnpm-lock\.yaml$' \
            --exclude-files 'package-lock\.json$' \
            --exclude-files '\.next/' \
            --exclude-files 'node_modules/' \
            --exclude-files '\.env\.example$' \
            --exclude-files '\.md$' \
            > secrets-report.json 2>&1 || true
          
          # Parse and display results
          python3 << 'PYEOF'
          import json
          import sys
          
          try:
              with open('secrets-report.json', 'r') as f:
                  report = json.load(f)
          except Exception as e:
              print(f"Could not parse report: {e}")
              sys.exit(0)
          
          results = report.get('results', {})
          total_secrets = sum(len(v) for v in results.values())
          
          if total_secrets == 0:
              print("No secrets detected - all clear!")
              sys.exit(0)
          
          print(f"WARNING: Found {total_secrets} potential secret(s) in {len(results)} file(s)")
          print("")
          
          for filepath, secrets in results.items():
              print(f"  File: {filepath}")
              for secret in secrets:
                  secret_type = secret.get('type', 'Unknown')
                  line = secret.get('line_number', '?')
                  print(f"    Line {line}: {secret_type}")
              print("")
          
          # Fail the build if real secrets are found
          # Filter out false positives (example files, test fixtures)
          real_secrets = {k: v for k, v in results.items() 
                         if not any(x in k for x in ['example', 'test', 'mock', 'fixture', '.md'])}
          
          if real_secrets:
              real_count = sum(len(v) for v in real_secrets.values())
              print(f"FAIL: {real_count} potential secret(s) found in production files!")
              print("Please remove or rotate these credentials immediately.")
              sys.exit(1)
          else:
              print("All detected items are in test/example files - passing.")
          PYEOF

      - name: Custom pattern scan
        if: always()
        run: |
          echo "=== Custom Pattern Scan ==="
          echo "Checking for common secret patterns..."
          
          # Search for common secret patterns (excluding known safe files)
          FOUND=0
          
          # Check for hardcoded API keys
          if grep -rn --include="*.js" --include="*.ts" --include="*.tsx" --include="*.jsx" \
            -E "(sk-[a-zA-Z0-9]{20,}|AKIA[0-9A-Z]{16}|ghp_[a-zA-Z0-9]{36})" \
            --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null; then
            echo "WARNING: Potential API key found!"
            FOUND=1
          fi
          
          # Check for hardcoded passwords in source
          if grep -rn --include="*.js" --include="*.ts" --include="*.tsx" --include="*.jsx" \
            -iE "password\s*[:=]\s*['\"][^'\"]{8,}['\"]" \
            --exclude-dir=node_modules --exclude-dir=.next \
            --exclude="*.test.*" --exclude="*.spec.*" . 2>/dev/null; then
            echo "WARNING: Potential hardcoded password found!"
            FOUND=1
          fi
          
          # Check for private keys
          if grep -rn "BEGIN.*PRIVATE KEY" \
            --exclude-dir=node_modules --exclude-dir=.next . 2>/dev/null; then
            echo "WARNING: Private key found in repository!"
            FOUND=1
          fi
          
          if [ $FOUND -eq 0 ]; then
            echo "No hardcoded secrets detected by custom patterns."
          else
            echo ""
            echo "Review the above findings and ensure no real secrets are committed."
            exit 1
          fi

      - name: Check .env files
        if: always()
        run: |
          echo "=== .env File Check ==="
          
          # Check if any .env files (non-example) are tracked
          ENV_FILES=$(find . -name ".env" -o -name ".env.local" -o -name ".env.production" | grep -v node_modules | grep -v .env.example || true)
          
          if [ -n "$ENV_FILES" ]; then
            echo "WARNING: .env files found in repository:"
            echo "$ENV_FILES"
            echo ""
            echo "These should be in .gitignore and not committed!"
            exit 1
          else
            echo "No .env files committed - good!"
          fi
          
          # Verify .gitignore includes .env
          if grep -q "\.env" .gitignore 2>/dev/null; then
            echo ".gitignore properly excludes .env files."
          else
            echo "WARNING: .gitignore does not exclude .env files!"
            exit 1
          fi
